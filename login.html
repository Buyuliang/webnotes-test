<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub ç™»å½• - è®°äº‹æœ¬</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }
        
        .login-box .description {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .device-code-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .user-code {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 8px;
            color: #667eea;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 2px dashed #667eea;
        }
        
        .verification-url {
            margin: 20px 0;
        }
        
        .verification-url a {
            color: #667eea;
            text-decoration: none;
            font-size: 16px;
            word-break: break-all;
        }
        
        .verification-url a:hover {
            text-decoration: underline;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-message.waiting {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .repo-input-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .repo-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .repo-input-section input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .repo-input-section small {
            display: block;
            color: #888;
            font-size: 12px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .repo-input-section small a {
            color: #667eea;
            text-decoration: none;
        }
        
        .repo-input-section small a:hover {
            text-decoration: underline;
        }
        
        .btn-start-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-start-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            color: #856404;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h1>ğŸ“ GitHub ç™»å½•</h1>
            <p class="description">
                ä½¿ç”¨ GitHub OAuth æˆæƒç™»å½•ï¼Œæˆ–ç›´æ¥è¾“å…¥ Personal Access Token
            </p>
            
            <div id="loginForm">
                <div class="repo-input-section" style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffc107; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="loginMethod" id="useToken" value="token" checked style="width: auto;">
                        <strong>æ–¹å¼ 1ï¼šç›´æ¥è¾“å…¥ Personal Access Tokenï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰</strong>
                    </label>
                    <small style="display: block; margin-top: 10px; margin-left: 25px; color: #856404;">
                        é€‚ç”¨äº GitHub Pages éƒ¨ç½²ï¼Œæ— éœ€é…ç½® OAuth App
                    </small>
                </div>
                
                <div class="repo-input-section" style="background: #e3f2fd; padding: 15px; border-radius: 6px; border: 1px solid #2196f3; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="loginMethod" id="useOAuth" value="oauth" style="width: auto;">
                        <strong>æ–¹å¼ 2ï¼šä½¿ç”¨ OAuth æˆæƒï¼ˆéœ€è¦é…ç½® OAuth Appï¼‰</strong>
                    </label>
                    <small style="display: block; margin-top: 10px; margin-left: 25px; color: #1565c0;">
                        é€‚ç”¨äºéœ€è¦åŠ¨æ€æˆæƒçš„åœºæ™¯ï¼Œä½†éœ€è¦åç«¯æœåŠ¡å™¨æ”¯æŒ
                    </small>
                </div>
                
                <!-- Token ç™»å½•æ–¹å¼ -->
                <div id="tokenLoginSection">
                    <div class="repo-input-section">
                        <label for="personalToken">GitHub Personal Access Token:</label>
                        <input type="password" id="personalToken" placeholder="ghp_xxxxxxxxxxxx" value="">
                        <small>
                            éœ€è¦ repo æƒé™ã€‚è®¿é—® <a href="https://github.com/settings/tokens/new" target="_blank">åˆ›å»º Token</a>
                            <br>å‹¾é€‰ <strong>repo</strong> æƒé™ï¼Œç”Ÿæˆåå¤åˆ¶å¹¶ç²˜è´´åˆ°è¿™é‡Œ
                        </small>
                    </div>
                    
                    <div class="repo-input-section">
                        <label for="repoNameToken">ä»“åº“åç§° (owner/repo):</label>
                        <input type="text" id="repoNameToken" placeholder="username/repo-name" value="Buyuliang/webnotes-test">
                        <small>è¯·è¾“å…¥ä½ çš„ GitHub ä»“åº“åç§°ï¼Œæ ¼å¼ï¼šusername/repo-name</small>
                    </div>
                    
                    <button id="loginWithTokenBtn" class="btn-start-login">ä½¿ç”¨ Token ç™»å½•</button>
                </div>
                
                <!-- OAuth ç™»å½•æ–¹å¼ -->
                <div id="oauthLoginSection" style="display: none;">
                <div class="repo-input-section">
                    <label for="clientId">OAuth App Client ID:</label>
                    <input type="text" id="clientId" placeholder="Iv1.xxxxxxxxxxxx" value="">
                    <small>
                        éœ€è¦åˆ›å»º GitHub OAuth App è·å– Client IDã€‚
                        <a href="https://github.com/settings/developers" target="_blank">åˆ›å»º OAuth App â†’</a>
                        <br>
                        <strong>æ³¨æ„ï¼š</strong>
                        <br>â€¢ å¦‚æœä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼šAuthorization callback URL å¡«å†™ http://localhost:3000/oauth/callback
                        <br>â€¢ å¦‚æœçº¯å‰ç«¯ï¼šAuthorization callback URL å¡«å†™å½“å‰é¡µé¢çš„å®Œæ•´ URLï¼ˆå¦‚ http://localhost:8000/login.htmlï¼‰
                    </small>
                </div>
                
                <div class="repo-input-section">
                    <label for="useBackend">ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆä»…æœ¬åœ°å¼€å‘ï¼‰:</label>
                    <input type="checkbox" id="useBackend">
                    <small>
                        <strong>æ³¨æ„ï¼š</strong>å¦‚æœéƒ¨ç½²åˆ° GitHub Pagesï¼Œè¯·<strong>ä¸è¦</strong>å‹¾é€‰æ­¤é¡¹ã€‚
                        <br>å‹¾é€‰åä½¿ç”¨æœ¬åœ°åç«¯æœåŠ¡å™¨å¤„ç† OAuth å›è°ƒï¼ˆä»…é€‚ç”¨äº localhost å¼€å‘ï¼‰ã€‚
                        <br>éœ€è¦å…ˆè¿è¡Œ: <code>npm install && node oauth-callback-server.js</code>
                    </small>
                </div>
                
                <div class="repo-input-section" id="redirectUriInfo" style="background: #f0f7ff; padding: 15px; border-radius: 6px; border: 1px solid #b3d9ff; margin-top: 10px;">
                    <strong style="color: #0066cc;">ğŸ“‹ é‡è¦ï¼šè¯·åœ¨ GitHub OAuth App ä¸­é…ç½®ä»¥ä¸‹å›è°ƒåœ°å€ï¼š</strong>
                    <div id="redirectUriDisplay" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-family: monospace; word-break: break-all; color: #d73502; font-weight: bold;">
                        ç­‰å¾…é€‰æ‹©...
                    </div>
                    <small style="display: block; margin-top: 10px; color: #666;">
                        <strong>é…ç½®æ­¥éª¤ï¼š</strong>
                        <br>1. è®¿é—® <a href="https://github.com/settings/developers" target="_blank">GitHub OAuth Apps</a>
                        <br>2. ç‚¹å‡»ä½ çš„ OAuth App æˆ–åˆ›å»ºæ–°åº”ç”¨
                        <br>3. æ‰¾åˆ° "Authorization callback URL" å­—æ®µ
                        <br>4. å°†ä¸Šé¢æ˜¾ç¤ºçš„åœ°å€<strong>å®Œæ•´å¤åˆ¶</strong>å¹¶ç²˜è´´åˆ°è¯¥å­—æ®µï¼ˆå¿…é¡»å®Œå…¨ä¸€è‡´ï¼ŒåŒ…æ‹¬ https://ï¼‰
                        <br>5. ç‚¹å‡» "Update application" ä¿å­˜
                        <br>6. ç­‰å¾…å‡ ç§’é’Ÿè®©é…ç½®ç”Ÿæ•ˆ
                        <br>7. è¿”å›æ­¤é¡µé¢é‡æ–°å°è¯•ç™»å½•
                        <br><br>
                        <strong>âš ï¸ é‡è¦ï¼šå›è°ƒåœ°å€å¿…é¡»ä»¥ login.html ç»“å°¾ï¼</strong>
                        <br>âœ… æ­£ç¡®ï¼š<code>https://buyuliang.github.io/webnotes-test/login.html</code>
                        <br>âŒ é”™è¯¯ï¼š<code>https://buyuliang.github.io/webnotes-test/index.html</code>
                        <br><br>
                        <strong>âš ï¸ å¸¸è§é”™è¯¯ï¼š</strong>
                        <br>â€¢ ä½¿ç”¨ index.html è€Œä¸æ˜¯ login.htmlï¼ˆé”™è¯¯ï¼ï¼‰
                        <br>â€¢ åœ°å€ä¸åŒ¹é…ï¼ˆå¤š/å°‘ä¸€ä¸ªæ–œæ ã€http vs httpsã€ç¼ºå°‘è·¯å¾„ç­‰ï¼‰
                        <br>â€¢ å¿˜è®°ä¿å­˜ OAuth App é…ç½®
                        <br>â€¢ é…ç½®æœªç”Ÿæ•ˆï¼ˆéœ€è¦ç­‰å¾…å‡ ç§’ï¼‰
                    </small>
                </div>
                
                <div class="repo-input-section">
                    <label for="repoName">ä»“åº“åç§° (owner/repo):</label>
                    <input type="text" id="repoName" placeholder="username/repo-name" value="Buyuliang/webnotes-test">
                    <small>è¯·è¾“å…¥ä½ çš„ GitHub ä»“åº“åç§°ï¼Œæ ¼å¼ï¼šusername/repo-name</small>
                </div>
                
                <button id="startLoginBtn" class="btn-start-login">ä½¿ç”¨ OAuth ç™»å½•</button>
                </div>
            </div>
            
            <div id="oauthInfo" class="device-code-section hidden">
                <h3>æ­£åœ¨è·³è½¬åˆ° GitHub æˆæƒé¡µé¢...</h3>
                <div id="statusMessage" class="status-message info"></div>
            </div>
            
            <div class="warning-box">
                <strong>âš ï¸ é‡è¦æç¤º</strong>
                <p><strong>å¦‚æœé‡åˆ°"é‡å®šå‘åœ°å€ä¸åŒ¹é…"é”™è¯¯ï¼š</strong></p>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>ç¡®ä¿ GitHub OAuth App ä¸­çš„ "Authorization callback URL" ä¸ä¸Šé¢æ˜¾ç¤ºçš„åœ°å€<strong>å®Œå…¨ä¸€è‡´</strong></li>
                    <li>åŒ…æ‹¬åè®®ï¼ˆhttp/httpsï¼‰ã€åŸŸåã€ç«¯å£å·ã€è·¯å¾„éƒ½å¿…é¡»ä¸€è‡´</li>
                    <li>ä¿å­˜ OAuth App é…ç½®åï¼Œå¯èƒ½éœ€è¦ç­‰å¾…å‡ ç§’é’Ÿæ‰èƒ½ç”Ÿæ•ˆ</li>
                    <li>å¦‚æœä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼Œç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ</li>
                </ol>
                <p style="margin-top: 10px;">
                    <strong>å®‰å…¨æç¤ºï¼š</strong>æ­¤æ–¹æ¡ˆä¸ºå¿«é€ŸåŸå‹æ–¹æ¡ˆï¼ŒToken ä¼šåœ¨æµè§ˆå™¨ä¸­å¯è§ã€‚ä»…ç”¨äºæ¼”ç¤ºæˆ–å†…éƒ¨ä½¿ç”¨ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
                </p>
            </div>
        </div>
    </div>
    
    <script src="github-auth.js"></script>
    <script>
        // æ£€æŸ¥æ˜¯å¦æ˜¯ OAuth å›è°ƒ
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const token = urlParams.get('token'); // ä»åç«¯æœåŠ¡å™¨è¿”å›çš„ token
        
        if (error) {
            // ç”¨æˆ·æ‹’ç»äº†æˆæƒæˆ–å…¶ä»–é”™è¯¯
            document.getElementById('loginForm').innerHTML = `
                <div class="status-message error">
                    <strong>æˆæƒå¤±è´¥</strong>
                    <p>${error === 'access_denied' ? 'æ‚¨å–æ¶ˆäº†æˆæƒ' : error === 'missing_config' ? 'æœåŠ¡å™¨é…ç½®ç¼ºå¤±' : error === 'server_error' ? 'æœåŠ¡å™¨é”™è¯¯' : error}</p>
                    <button onclick="window.location.href='login.html'" class="btn-start-login" style="margin-top: 15px;">é‡æ–°ç™»å½•</button>
                </div>
            `;
        } else if (token && state) {
            // ä»åç«¯æœåŠ¡å™¨è·å–åˆ° token
            handleTokenReceived(token, state);
        } else if (code && state) {
            // OAuth å›è°ƒï¼Œå°è¯•ç›´æ¥è·å– tokenï¼ˆå¯èƒ½ä¼šå› ä¸º CORS å¤±è´¥ï¼‰
            handleOAuthCallback(code, state);
        } else {
            // æ˜¾ç¤ºç™»å½•è¡¨å•
            initLoginForm();
        }
        
        function handleTokenReceived(token, state) {
            // éªŒè¯ state
            const savedState = sessionStorage.getItem('oauth_state');
            if (!savedState || savedState !== state) {
                document.getElementById('loginForm').innerHTML = `
                    <div class="status-message error">
                        <strong>å®‰å…¨éªŒè¯å¤±è´¥</strong>
                        <p>State éªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©</p>
                        <button onclick="window.location.href='login.html'" class="btn-start-login" style="margin-top: 15px;">é‡æ–°ç™»å½•</button>
                    </div>
                `;
                return;
            }
            
            // è·å–ä¿å­˜çš„é…ç½®
            const repoName = sessionStorage.getItem('oauth_repo');
            
            // ä¿å­˜ token
            localStorage.setItem('github_token', token);
            localStorage.setItem('github_repo', repoName);
            
            // æ¸…é™¤ sessionStorage
            sessionStorage.removeItem('oauth_state');
            sessionStorage.removeItem('oauth_repo');
            sessionStorage.removeItem('oauth_client_id');
            sessionStorage.removeItem('oauth_redirect_uri');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è·³è½¬
            const loginForm = document.getElementById('loginForm');
            const oauthInfo = document.getElementById('oauthInfo');
            loginForm.classList.add('hidden');
            oauthInfo.classList.remove('hidden');
            showStatus('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
        async function handleOAuthCallback(code, state) {
            const loginForm = document.getElementById('loginForm');
            const oauthInfo = document.getElementById('oauthInfo');
            const statusMessageEl = document.getElementById('statusMessage');
            
            loginForm.classList.add('hidden');
            oauthInfo.classList.remove('hidden');
            showStatus('æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...', 'info');
            
            try {
                const token = await githubAuth.handleCallback(code, state);
                
                // è·å–ä¿å­˜çš„é…ç½®
                const repoName = sessionStorage.getItem('oauth_repo');
                
                // ä¿å­˜ token
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_repo', repoName);
                
                showStatus('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                
                // æ¸…é™¤ sessionStorage
                sessionStorage.removeItem('oauth_state');
                sessionStorage.removeItem('oauth_repo');
                sessionStorage.removeItem('oauth_client_id');
                sessionStorage.removeItem('oauth_redirect_uri');
                
                // è·³è½¬åˆ°ä¸»é¡µé¢
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                showStatus(`è‡ªåŠ¨è·å– Token å¤±è´¥: ${error.message}`, 'error');
                
                // æä¾›æ›¿ä»£æ–¹æ¡ˆ
                setTimeout(() => {
                    oauthInfo.innerHTML = `
                        <div class="status-message error">
                            <strong>è‡ªåŠ¨è·å– Token å¤±è´¥</strong>
                            <p>${error.message}</p>
                            <p style="margin-top: 15px;">
                                <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                                <br>1. ä½¿ç”¨åç«¯æœåŠ¡å™¨å¤„ç† OAuth å›è°ƒï¼ˆæ¨èï¼‰
                                <br>2. æˆ–æ‰‹åŠ¨åˆ›å»º Personal Access Token
                            </p>
                            <div style="margin-top: 15px;">
                                <button onclick="window.location.href='login.html'" class="btn-start-login">è¿”å›ç™»å½•</button>
                                <a href="https://github.com/settings/tokens/new" target="_blank" class="btn-start-login" style="margin-left: 10px; text-decoration: none; display: inline-block;">åˆ›å»º Token</a>
                            </div>
                        </div>
                    `;
                }, 2000);
            }
        }
        
        function updateRedirectUriDisplay() {
            const useBackend = document.getElementById('useBackend');
            if (!useBackend) return;
            
            const useBackendChecked = useBackend.checked;
            const redirectUriDisplay = document.getElementById('redirectUriDisplay');
            
            let redirectUri;
            if (useBackendChecked) {
                // ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆä»…æœ¬åœ°å¼€å‘ï¼‰
                redirectUri = 'http://localhost:3000/oauth/callback';
            } else {
                // ä½¿ç”¨å½“å‰é¡µé¢ï¼ˆé€‚ç”¨äº GitHub Pages å’Œç”Ÿäº§ç¯å¢ƒï¼‰
                // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„ URLï¼ŒåŒ…æ‹¬åè®®ã€åŸŸåå’Œè·¯å¾„
                let currentPath = window.location.pathname;
                
                // ç¡®ä¿è·¯å¾„æŒ‡å‘ login.htmlï¼ˆå¦‚æœå½“å‰ä¸åœ¨ login.htmlï¼Œåˆ™ä½¿ç”¨ login.htmlï¼‰
                if (!currentPath.endsWith('login.html')) {
                    // å¦‚æœå½“å‰åœ¨ index.html æˆ–å…¶ä»–é¡µé¢ï¼Œæ”¹ä¸º login.html
                    const pathParts = currentPath.split('/');
                    pathParts[pathParts.length - 1] = 'login.html';
                    currentPath = pathParts.join('/');
                }
                
                redirectUri = window.location.origin + currentPath;
                
                // å¦‚æœæ˜¯ GitHub Pagesï¼Œç¡®ä¿ä½¿ç”¨ HTTPS
                if (window.location.hostname.includes('github.io') || window.location.protocol === 'https:') {
                    redirectUri = redirectUri.replace('http://', 'https://');
                }
            }
            
            redirectUriDisplay.textContent = redirectUri;
            redirectUriDisplay.style.color = '#d73502';
            
            // æ·»åŠ å¤åˆ¶æŒ‰é’®æç¤º
            if (redirectUriDisplay.nextElementSibling && redirectUriDisplay.nextElementSibling.classList.contains('copy-hint')) {
                redirectUriDisplay.nextElementSibling.remove();
            }
            const copyHint = document.createElement('small');
            copyHint.className = 'copy-hint';
            copyHint.style.display = 'block';
            copyHint.style.marginTop = '5px';
            copyHint.style.color = '#666';
            copyHint.innerHTML = 'ğŸ’¡ ç‚¹å‡»å¤åˆ¶åœ°å€';
            redirectUriDisplay.parentNode.insertBefore(copyHint, redirectUriDisplay.nextSibling);
            
            // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
            redirectUriDisplay.style.cursor = 'pointer';
            redirectUriDisplay.title = 'ç‚¹å‡»å¤åˆ¶';
            redirectUriDisplay.onclick = function() {
                navigator.clipboard.writeText(redirectUri).then(() => {
                    const originalText = redirectUriDisplay.textContent;
                    redirectUriDisplay.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                    redirectUriDisplay.style.color = '#27ae60';
                    setTimeout(() => {
                        redirectUriDisplay.textContent = originalText;
                        redirectUriDisplay.style.color = '#d73502';
                    }, 2000);
                }).catch(() => {
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œå°è¯•é€‰ä¸­æ–‡æœ¬
                    const range = document.createRange();
                    range.selectNode(redirectUriDisplay);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                });
            };
        }
        
        // åˆ‡æ¢ç™»å½•æ–¹å¼
        function switchLoginMethod() {
            const useToken = document.getElementById('useToken').checked;
            const tokenSection = document.getElementById('tokenLoginSection');
            const oauthSection = document.getElementById('oauthLoginSection');
            
            if (useToken) {
                tokenSection.style.display = 'block';
                oauthSection.style.display = 'none';
            } else {
                tokenSection.style.display = 'none';
                oauthSection.style.display = 'block';
            }
        }
        
        // Token ç™»å½•
        async function loginWithToken() {
            const token = document.getElementById('personalToken').value.trim();
            const repoName = document.getElementById('repoNameToken').value.trim();
            
            if (!token) {
                showStatus('è¯·è¾“å…¥ Personal Access Token', 'error');
                return;
            }
            
            if (!repoName) {
                showStatus('è¯·è¾“å…¥ä»“åº“åç§°', 'error');
                return;
            }
            
            // éªŒè¯ä»“åº“åç§°æ ¼å¼
            if (!/^[\w\-\.]+\/[\w\-\.]+$/.test(repoName)) {
                showStatus('ä»“åº“åç§°æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºï¼šusername/repo-name', 'error');
                return;
            }
            
            // éªŒè¯ token æ ¼å¼ï¼ˆGitHub token é€šå¸¸ä»¥ ghp_ å¼€å¤´ï¼‰
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                if (!confirm('Token æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ã€‚GitHub Personal Access Token é€šå¸¸ä»¥ "ghp_" æˆ– "github_pat_" å¼€å¤´ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    return;
                }
            }
            
            const loginBtn = document.getElementById('loginWithTokenBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'éªŒè¯ Token...';
            
            try {
                // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Token æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®');
                    }
                    throw new Error(`éªŒè¯å¤±è´¥: ${response.status}`);
                }
                
                const userData = await response.json();
                console.log('ç™»å½•ç”¨æˆ·:', userData.login);
                
                // ä¿å­˜é…ç½®
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_repo', repoName);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const loginForm = document.getElementById('loginForm');
                const oauthInfo = document.getElementById('oauthInfo');
                loginForm.classList.add('hidden');
                oauthInfo.classList.remove('hidden');
                showStatus(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${userData.login}ï¼Œæ­£åœ¨è·³è½¬...`, 'success');
                
                // è·³è½¬åˆ°ä¸»é¡µé¢
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                showStatus(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ä½¿ç”¨ Token ç™»å½•';
            }
        }
        
        function initLoginForm() {
            const startLoginBtn = document.getElementById('startLoginBtn');
            const loginForm = document.getElementById('loginForm');
            const repoNameInput = document.getElementById('repoName');
            const clientIdInput = document.getElementById('clientId');
            const useBackendCheckbox = document.getElementById('useBackend');
            
            // ç›‘å¬ç™»å½•æ–¹å¼åˆ‡æ¢
            document.getElementById('useToken').addEventListener('change', switchLoginMethod);
            document.getElementById('useOAuth').addEventListener('change', switchLoginMethod);
            
            // Token ç™»å½•æŒ‰é’®
            const loginWithTokenBtn = document.getElementById('loginWithTokenBtn');
            if (loginWithTokenBtn) {
                loginWithTokenBtn.addEventListener('click', loginWithToken);
            }
            
            // ä» localStorage è·å–ä¿å­˜çš„ token å’Œä»“åº“åç§°ï¼ˆç”¨äº Token ç™»å½•ï¼‰
            const savedToken = localStorage.getItem('github_token');
            const savedRepo = localStorage.getItem('github_repo');
            if (savedToken && savedRepo) {
                document.getElementById('personalToken').value = savedToken;
                document.getElementById('repoNameToken').value = savedRepo;
            } else if (!savedRepo) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä»“åº“åç§°ï¼Œä½¿ç”¨é»˜è®¤å€¼
                document.getElementById('repoNameToken').value = 'Buyuliang/webnotes-test';
            }
            
            // ä» URL å‚æ•°æˆ– localStorage è·å–ä»“åº“åç§°ï¼ˆç”¨äº OAuth ç™»å½•ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const repoFromUrl = urlParams.get('repo');
            if (repoFromUrl) {
                repoNameInput.value = repoFromUrl;
            } else {
                const savedRepo = localStorage.getItem('github_repo');
                if (savedRepo) {
                    repoNameInput.value = savedRepo;
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä»“åº“åç§°ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    repoNameInput.value = 'Buyuliang/webnotes-test';
                }
            }
            
            // ä» localStorage è·å–ä¿å­˜çš„ client_id
            const savedClientId = localStorage.getItem('github_client_id');
            if (savedClientId) {
                clientIdInput.value = savedClientId;
            }
            
            // ä» localStorage è·å–æ˜¯å¦ä½¿ç”¨åç«¯
            const savedUseBackend = localStorage.getItem('use_backend');
            if (savedUseBackend === 'true') {
                useBackendCheckbox.checked = true;
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤º redirect_uri
            updateRedirectUriDisplay();
            
            // ç›‘å¬åç«¯æœåŠ¡å™¨é€‰é¡¹å˜åŒ–
            useBackendCheckbox.addEventListener('change', updateRedirectUriDisplay);
            
            startLoginBtn.addEventListener('click', () => {
                const clientId = clientIdInput.value.trim();
                const repoName = repoNameInput.value.trim();
                const useBackend = useBackendCheckbox.checked;
                
                if (!clientId) {
                    showStatus('è¯·è¾“å…¥ OAuth App Client ID', 'error');
                    return;
                }
                
                if (!repoName) {
                    showStatus('è¯·è¾“å…¥ä»“åº“åç§°', 'error');
                    return;
                }
                
                // éªŒè¯ä»“åº“åç§°æ ¼å¼
                if (!/^[\w\-\.]+\/[\w\-\.]+$/.test(repoName)) {
                    showStatus('ä»“åº“åç§°æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºï¼šusername/repo-name', 'error');
                    return;
                }
                
                // ç¡®å®š redirect_uri
                let redirectUri;
                if (useBackend) {
                    // ä½¿ç”¨åç«¯æœåŠ¡å™¨ï¼ˆä»…æœ¬åœ°å¼€å‘ï¼‰
                    redirectUri = 'http://localhost:3000/oauth/callback';
                    
                    // æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
                    fetch('http://localhost:3000/oauth/callback?test=1')
                        .catch(() => {
                            if (confirm('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ (http://localhost:3000)ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿå¦‚æœåç«¯æœªè¿è¡Œï¼Œç™»å½•å°†å¤±è´¥ã€‚')) {
                                proceedWithLogin();
                            }
                        });
                    
                    function proceedWithLogin() {
                        // ä¿å­˜é…ç½®
                        localStorage.setItem('github_repo', repoName);
                        localStorage.setItem('github_client_id', clientId);
                        localStorage.setItem('use_backend', useBackend);
                        
                        // å¯åŠ¨ OAuth æµç¨‹
                        githubAuth.startOAuthFlow(repoName, clientId, redirectUri);
                    }
                    
                    proceedWithLogin();
                } else {
                    // ä½¿ç”¨å½“å‰é¡µé¢ï¼ˆé€‚ç”¨äº GitHub Pages å’Œç”Ÿäº§ç¯å¢ƒï¼‰
                    let currentPath = window.location.pathname;
                    
                    // ç¡®ä¿è·¯å¾„æŒ‡å‘ login.htmlï¼ˆå¦‚æœå½“å‰ä¸åœ¨ login.htmlï¼Œåˆ™ä½¿ç”¨ login.htmlï¼‰
                    if (!currentPath.endsWith('login.html')) {
                        // å¦‚æœå½“å‰åœ¨ index.html æˆ–å…¶ä»–é¡µé¢ï¼Œæ”¹ä¸º login.html
                        const pathParts = currentPath.split('/');
                        pathParts[pathParts.length - 1] = 'login.html';
                        currentPath = pathParts.join('/');
                    }
                    
                    redirectUri = window.location.origin + currentPath;
                    
                    // å¦‚æœæ˜¯ GitHub Pagesï¼Œç¡®ä¿ä½¿ç”¨ HTTPS
                    if (window.location.hostname.includes('github.io') || window.location.protocol === 'https:') {
                        redirectUri = redirectUri.replace('http://', 'https://');
                    }
                    
                    // éªŒè¯ redirect_uri æ ¼å¼
                    console.log('ä½¿ç”¨çš„å›è°ƒåœ°å€:', redirectUri);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é…ç½®äº†é”™è¯¯çš„å›è°ƒåœ°å€ï¼ˆindex.htmlï¼‰
                    const wrongCallbackUrl = redirectUri.replace('login.html', 'index.html');
                    const warningMessage = 
                        'âš ï¸ é‡è¦æç¤ºï¼š\n\n' +
                        'å›è°ƒåœ°å€å¿…é¡»æ˜¯ï¼š\n' + redirectUri + '\n\n' +
                        'âŒ ä¸è¦ä½¿ç”¨ï¼š' + wrongCallbackUrl + '\n\n' +
                        'è¯·ç¡®è®¤ GitHub OAuth App ä¸­çš„ "Authorization callback URL" é…ç½®ä¸ºï¼š\n' + 
                        redirectUri + '\n\n' +
                        'ï¼ˆå¿…é¡»ä»¥ login.html ç»“å°¾ï¼Œä¸æ˜¯ index.htmlï¼‰\n\n' +
                        'ç‚¹å‡»"ç¡®å®š"ç»§ç»­ç™»å½•ï¼Œæˆ–"å–æ¶ˆ"è¿”å›é…ç½®ã€‚';
                    
                    // ä¿å­˜é…ç½®
                    localStorage.setItem('github_repo', repoName);
                    localStorage.setItem('github_client_id', clientId);
                    localStorage.setItem('use_backend', useBackend);
                    
                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œç¡®ä¿ç”¨æˆ·å·²é…ç½® OAuth App
                    const confirmed = confirm(warningMessage);
                    
                    if (confirmed) {
                        // å¯åŠ¨ OAuth æµç¨‹
                        githubAuth.startOAuthFlow(repoName, clientId, redirectUri);
                    }
                }
            });
        }
        
        function showStatus(message, type) {
            const statusMessageEl = document.getElementById('statusMessage');
            if (statusMessageEl) {
                statusMessageEl.textContent = message;
                statusMessageEl.className = `status-message ${type}`;
                statusMessageEl.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

